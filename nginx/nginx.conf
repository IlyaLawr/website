# 1) Принудительный редирект HTTP → HTTPS
server {
    listen 80;
    server_name 176.53.163.96;

    location / {
        proxy_pass http://api:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}

# 2) HTTPS-конфигурация с SSL и защитными заголовками
server {
    listen 443 ssl http2;
    server_name 176.53.163.96;

    # SSL-сертификаты
    ssl_certificate      /etc/nginx/ssl/nginx-selfsigned.crt;
    ssl_certificate_key  /etc/nginx/ssl/nginx-selfsigned.key;

    # Протоколы и шифры
    ssl_protocols             TLSv1.2 TLSv1.3;
    ssl_ciphers               HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Кэширование сессий
    ssl_session_cache   shared:SSL:10m;
    ssl_session_timeout 1h;

    # Защитные заголовки
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options SAMEORIGIN always;
    add_header X-Content-Type-Options nosniff always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # Таймауты прокси
    proxy_connect_timeout 30s;
    proxy_send_timeout    30s;
    proxy_read_timeout    90s;

    location / {
        proxy_pass         http://api:8000;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   X-Forwarded-Host  $host;
        proxy_set_header   Proxy             "";
    }
}
